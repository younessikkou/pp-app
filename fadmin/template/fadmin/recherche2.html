{% extends '../base/base.html' %}
{% load static %}

{% block content %}
<!--modal filtring search-->

<h3>{{ context.error }}</h3>
<div class="container">
  <div class="row">
    <div class="col-md-6">
      <!--date fadmin start picker-->
      <div class="container">
        <div class="row">
          <h2 class="py-2"> <h2>
        </div>
        <div class="row">
          <h3>تاريخ البداية  <i class="fa fa-calendar" style="font-size:24px"></i>:</h3>
          <input type="text" class="form-control datedebut datepicker"  placeholder="تاريخ البداية">
        </div>
        <br>
        <div class="row">
          <h3>نوع المحضر <i class="fa fa-file" style="font-size:24px"></i>:</h3>
          <select name="typerapp" class="form-control typerappajax">
            {% for t in data0 %}
            <option value="{{t.id}}" >{{ t.nom_typerapp }}</option>
            {% endfor %}
          </select>           
        </div>  
      </div>
    </div>
    <!---->
    <!--date fadmin start picker-->
    <div class="col-md-6">
      <div class="container">
        <div class="row">
          <h2 class="py-2"> </h2>
        </div>
        <div class="row">
          <h3>تاريخ النهاية  <i class="fa fa-calendar" style="font-size:24px"></i>:</h3>
          <input type="text" class="form-control datefin datepicker"  placeholder="تاريخ النهاية">
        </div>
        <br> 
        <div class="row">
          <!--search closet-->
          
          <!-- end of search closet-->
        </div> 
      </div>
    </div>
    <!---->
  </div>
  <br>
  <hr>
  <div class="row">
    <div class="col-md-6">
      <button class="btn btn-success ajax-call">البحث عن الملفات <i class="fa fa-search"></i></button>
    </div>
    <div class="col-md-6">
      <button class="btn btn-danger rappdownload">تحميل المحاضر</button>
    </div>
  </div>        
</div>         
<hr>         

<!--Table closet-->
<!--Table closet-->
<div class="container" id="PDFcontent" style="max-height: 400px; overflow-y: scroll;">
  <table class="table table-striped dt-responsive" style="width:100%">
    <thead class="thead_dark">
      <tr>
        <th class="th_text arabicfont">id</th>
        <th class="th_text arabicfont">تاريخ التوصل</th>
        <th class="th_text arabicfont">رقم الارسال</th>
        <th class="th_text arabicfont">رقم المحضر الضابطة القضائية</th>
        <th class="th_text arabicfont">رقم محضر النيابة العامة</th>
        <th class="th_text arabicfont">رقم شكاية النيابة العامة</th> 
        <th class="th_text arabicfont">الملاحظات</th>
        <th class="th_text arabicfont">تعديل</th>
        <th class="th_text arabicfont">حذف</th>
        <th class="th_text arabicfont">اختيار</th>

       <!-- <th class="th_text arabicfont">اختيار</th>-->
      </tr>
    </thead>
    <tbody id="trapp">
      <!-- Exemple de ligne -->
      <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <!--<td><input class="form-check-input" type="checkbox" value=""></td>-->
      </tr>
      <!-- Ajoutez ici d'autres lignes en JavaScript lors de la récupération des données -->
    </tbody>
  </table>
</div>


<div class="container">
  <div class="row">
    <div class="col-md-4">
      <button class="btn btn-success ihala">احالة الملفات</button>
    </div>
    <div class="col-md-4">
      <input type="text" class="form-control textihala" placeholder="شعبة الاحالة">
    </div>
    <div class="col-md-4">
      <input type="text" class="form-control datepicker dateihala" placeholder="المرجوا اختيار تاريخ الاحالة">
    </div>
  </div>  
</div>

<!--modal filtring search-->

<!-- Votre code HTML existant -->
<!--Table closet-->

<script>
  $(".ajax-call").click(function(){
      var datedebut = $(".datedebut").val();
      var datefin = $(".datefin").val();
      var typerapp = $(".typerappajax option:selected").val();
      var form = $(this).closest("form");
      console.log("itsme typerappy"+typerapp)
      $.ajax({
          url : ("rechercherapp"),
          type: 'POST', 
          data : {
             csrfmiddlewaretoken: '{{ csrf_token }}',
            'datedebut' : datedebut,
            'datefin' : datefin,
            'typerapp' : typerapp
          },
          dataType : 'json',
          success: function(dataajax){
              console.log(dataajax.item)
              var select = $("#trapp");
              select.empty(); // Videz les options existantes
              dataajax.item.forEach(function(item) {
                  var row = '<tr>';
                  row += '<td>' + item.id + '</td>';
                  row += '<td>' + item.date_arr + '</td>';
                  row += '<td>' + (item.num_env ? item.num_env : "غير متوفر") + '</td>';
                  row += '<td>' + (item.num_rapp_pj ? item.num_rapp_pj : "غير متوفر") + '</td>';
                  row += '<td>' + (item.num_rapp_pp ? item.num_rapp_pp : "غير متوفر") + '</td>';
                  row += '<td>' + (item.num_plaint ? item.num_plaint : "غير متوفر") + '</td>';
                  row += '<td>' + (item.note ? item.note : "لا يوجد ملاحظات") + '</td>';
                  row += '<td><a href="update/'+item.id+'/"><i class="fa fa-pen" aria-hidden="true"></i></a></td>';
                  row += '<td><a href="delete/'+item.id+'"><i class="fa fa-trash" style="color:red"></i></a></td>';
                  row += '<td><input type="checkbox" value="data-dossier-id="' + item.id + '"></input></td>';

                  
                  // Ajoutez la case à cocher dans la même cellule que les autres données
                  

                  row += '</tr>';
                  
                  select.append(row);
              });            
          },
          error: function(xhr, status, error) { // Error handling
              console.log("Error: " + error);
              console.log("Status: " + status);
              console.dir(xhr);
          }
      })
  });
  </script>
  

<script>
$(".ihala").click(function(){
    var datedebut = $(".datedebut").val();
    var datefin = $(".datefin").val();
    var typerapp = $(".typerappajax option:selected").val();
    var selectedDossiers = [];
    var dateihala = $(".dateihala").val();
    var textihala = $(".textihala").val() +" في تاريخ "+  dateihala;
    
    // Parcourez toutes les cases à cocher avec l'id "flexCheckChecked"
    $("#trapp input[type='checkbox']:checked").each(function(){
        // Récupérez l'ID du dossier stocké dans la propriété data
        var dossierId = $(this).data('dossier-id');
        selectedDossiers.push(dossierId);
    });
    console.log(selectedDossiers)
    $.ajax({
      url : ("ihala"),
      type: 'POST',
      data : {
          csrfmiddlewaretoken: '{{ csrf_token }}',
          'datedebut' : datedebut,
          'datefin' : datefin,
          'typerapp' : typerapp,
          'id' : selectedDossiers,
          'textihala' : textihala,
      },
      dataType : 'json',
      success: function(dataajax){
        alert("لقد تمت الاحالة")
        },
      error: function(xhr, status, error) { // Error handling
      console.log("Error: " + error);
      console.log("Status: " + status);
      console.dir(xhr);
      }
  })

    // Affichez les identifiants des dossiers sélectionnés dans la console

    // Vous pouvez maintenant envoyer ces identifiants au backend si nécessaire
});

</script>


<!--pdf download-->
<script>
$(".rappdownload").click(function(){
    var datedebut = $(".datedebut").val();
    var datefin = $(".datefin").val();
    var typerapp = $(".typerappajax option:selected").val();
    
    $.ajax({
        url: "rappdownload",
        type: 'POST', 
        data: {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            'datedebut': datedebut,
            'datefin': datefin,
            'typerapp': typerapp
        },
        xhrFields: {
          responseType: 'blob' // Définir le type de réponse comme un objet blob
        },
        success: function(data, status, xhr) {
            var blob = new Blob([data], { type: 'application/pdf' });
            saveAs(blob, 'donnees.pdf'); // Télécharger le fichier PDF en utilisant FileSaver.js
        },
        error: function(xhr, status, error) { 
            console.log("Erreur lors du téléchargement du fichier PDF : " + error);
        }
    });
});
</script>

<script>
$.ajax({
  // Votre code AJAX ici
  success: function(response) {
      // Remplacer le contenu de votre div de pagination avec la pagination renvoyée depuis le serveur
      $('#pagination-container').html(response.pagination_html);
  },
  error: function(xhr, status, error) {
      console.log("Erreur: " + error);
      console.dir(xhr);
  }
});
</script>
{% endblock %}
